/* ZVM v1.1.1 https://github.com/curiousdannii/ifvms.js */
var _Mathmin=Math.min,_StringfromCharCode=String.fromCharCode;(function(p){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=p();else if("function"==typeof define&&define.amd)define([],p);else{var d;d="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,d.ZVM=p()}})(function(){return function h(U,k,w){function v(C,S){if(!k[C]){if(!U[C]){var A="function"==typeof require&&require;if(!S&&A)return A(C,!0);if(y)return y(C,!0);var F=new Error("Cannot find module '"+C+"'");throw F.code="MODULE_NOT_FOUND",F}var G=k[C]={exports:{}};U[C][0].call(G.exports,function(D){var O=U[C][1][D];return v(O?O:D)},G,G.exports,h,U,k,w)}return k[C].exports}for(var y="function"==typeof require&&require,x=0;x<w.length;x++)v(w[x]);return v}({1:[function(h,U){var w=function(){"use strict";function v(O,E,M,z,B){function R(L,Z){if(null===L)return null;if(0===Z)return L;var N,q;if("object"!=typeof L)return L;if(L instanceof F)N=new F;else if(L instanceof G)N=new G;else if(L instanceof D)N=new D(function(oe,ae){L.then(function(le){oe(R(le,Z-1))},function(le){ae(R(le,Z-1))})});else if(v.__isArray(L))N=[];else if(v.__isRegExp(L))N=new RegExp(L.source,A(L)),L.lastIndex&&(N.lastIndex=L.lastIndex);else if(v.__isDate(L))N=new Date(L.getTime());else{if(V&&Buffer.isBuffer(L))return N=new Buffer(L.length),L.copy(N),N;L instanceof Error?N=Object.create(L):"undefined"==typeof z?(q=Object.getPrototypeOf(L),N=Object.create(q)):(N=Object.create(z),q=z)}if(E){var T=I.indexOf(L);if(-1!=T)return P[T];I.push(L),P.push(N)}if(L instanceof F)for(var J,Q=L.keys();J=Q.next(),!J.done;){var K=R(J.value,Z-1),W=R(L.get(J.value),Z-1);N.set(K,W)}if(L instanceof G)for(var J,Y,X=L.keys();J=X.next(),!J.done;)Y=R(J.value,Z-1),N.add(Y);for(var H in L){var $;(q&&($=Object.getOwnPropertyDescriptor(q,H)),!($&&null==$.set))&&(N[H]=R(L[H],Z-1))}if(Object.getOwnPropertySymbols)for(var ee=Object.getOwnPropertySymbols(L),H=0;H<ee.length;H++){var te=ee[H],se=Object.getOwnPropertyDescriptor(L,te);(!se||se.enumerable||B)&&(N[te]=R(L[te],Z-1),se.enumerable||Object.defineProperty(N,te,{enumerable:!1}))}if(B)for(var ne=Object.getOwnPropertyNames(L),H=0;H<ne.length;H++){var ie=ne[H],se=Object.getOwnPropertyDescriptor(L,ie);se&&se.enumerable||(N[ie]=R(L[ie],Z-1),Object.defineProperty(N,ie,{enumerable:!1}))}return N}"object"==typeof E&&(M=E.depth,z=E.prototype,B=E.includeNonEnumerable,E=E.circular);var I=[],P=[],V="undefined"!=typeof Buffer;return"undefined"==typeof E&&(E=!0),"undefined"==typeof M&&(M=Infinity),R(O,M)}function y(O){return Object.prototype.toString.call(O)}function A(O){var E="";return O.global&&(E+="g"),O.ignoreCase&&(E+="i"),O.multiline&&(E+="m"),E}var F;try{F=Map}catch(O){F=function(){}}var G;try{G=Set}catch(O){G=function(){}}var D;try{D=Promise}catch(O){D=function(){}}return v.clonePrototype=function(E){if(null===E)return null;var M=function(){};return M.prototype=E,new M},v.__objToStr=y,v.__isDate=function(O){return"object"==typeof O&&"[object Date]"===y(O)},v.__isArray=function(O){return"object"==typeof O&&"[object Array]"===y(O)},v.__isRegExp=function(O){return"object"==typeof O&&"[object RegExp]"===y(O)},v.__getRegExpFlags=A,v}();"object"==typeof U&&U.exports&&(U.exports=w)},{}],2:[function(h,U){"use strict";var v=h("../common/utils.js"),y=v.Class,x=v.U2S16,C=y.subClass({init:function(V,L){this.e=V,this.v=L},toString:function(){return this.v},U2S:function(){return x(this.v)}}),S=C.subClass({toString:function(){var V=this.v;return this.indirect?"e.indirect("+V+")":0===V?"s[--e.sp]":15>--V?"l["+V+"]":"e.m.getUint16("+(this.e.globals+2*(V-15))+")"},store:function(V){var L=this.v;return this.indirect?"e.indirect("+L+","+V+")":this.returnval?"e.variable("+L+","+V+")":0===L?"t="+V+";s[e.sp++]=t":15>--L?"l["+L+"]="+V:"e.ram.setUint16("+(this.e.globals+2*(L-15))+","+V+")"},U2S:function(){return"e.U2S("+this+")"}}),A=y.subClass({init:function(V,L,Z,N,q,T){this.e=V,this.context=L,this.code=Z,this.pc=N,this.labels=[this.pc+"/"+this.code],this.next=q,this.operands=T,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(V){return this.operands.join(V)},label:function(){return"/* "+this.labels.join()+" */ "}}),F=A.subClass({stopper:1}),G=F.subClass({post:function(){this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.stop=1;e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),D=G.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc}}),O=y.subClass({init:function(V,L){this.ops=V||[],this.code=L||"||"},toString:function(){for(var Z,V=0,L=[];V<this.ops.length;)Z=this.ops[V++],L.push(Z.func?(Z.iftrue?"":"!(")+Z.func.apply(Z,Z.operands)+(Z.iftrue?"":")"):Z);return(this.invert?"(!(":"(")+L.join(this.code)+(this.invert?"))":")")}}),E=A.subClass({brancher:1,keyword:"if",post:function(){var V,L,Z=this.operands.pop(),N=Z[1];this.iftrue=Z[0],0===N||1===N?V="e.ret("+N+")":(N+=this.next-2,this.context.targets.push(N),V="e.pc="+N),this.result=V+";return",this.offset=N,this.cond=new O([this]),this.context.ops.length&&(L=this.context.ops.pop(),L.offset===N?(this.cond.ops.unshift(L.cond),this.labels=L.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(L))},toString:function(){var V=this.result;return V instanceof I&&(this.e.options.debug&&(V.context=this.context),V+=V.stopper?"; return":"",1<this.result.ops.length&&(V="\n"+V+"\n",this.e.options.debug&&(V+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+V+"}"}}),M=E.subClass({storer:1,post:function(){M.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),z=A.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var V=z.super.toString.call(this);return this.storer?this.storer.store(V):V}}),B=F.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),R=B.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),I=y.subClass({init:function(V,L){this.e=V,this.pc=L,this.pre=[],this.ops=[],this.post=[],this.targets=[],V.options.debug&&(this.spacer="")},toString:function(){return this.e.options.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(1<this.ops.length?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),P=I.subClass({toString:function(){return this.pre.unshift("var l=e.l,s=e.s,t=0;\n"),P.super.toString.call(this)}});U.exports={Operand:C,Variable:S,Opcode:A,Stopper:F,Pauser:G,PauserStorer:D,BrancherLogic:O,Brancher:E,BrancherStorer:M,Storer:z,Caller:B,CallerStorer:R,Context:I,RoutineContext:P,opcode_builder:function(V,L,Z){return Z=Z||{},L&&(Z.func=L),V.subClass(Z)}}},{"../common/utils.js":4}],3:[function(h,U){"use strict";var v=h("./utils.js"),y=v.MemoryView,x=v.Class.subClass({init:function(A){if(this.type="",this.chunks=[],A){var D,O,F=y(A),G=12;if("FORM"!==F.getFourCC(0))throw new Error("Not an IFF file");for(this.type=F.getFourCC(8),D=F.getUint32(4)+8;G<D;){if(O=F.getUint32(G+4),0>O||O+G>D)throw new Error("IFF chunk out of range");this.chunks.push({type:F.getFourCC(G),offset:G,data:F.getUint8Array(G+8,O)}),G+=8+O,O%2&&G++}}},write:function(){for(var D,O,A=12,F=0,G=12;F<this.chunks.length;)this.chunks[F].data.buffer&&(this.chunks[F].data=this.chunks[F].data.buffer),this.chunks[F].length=this.chunks[F].data.byteLength||this.chunks[F].data.length,A+=8+this.chunks[F++].length,A%2&&A++;for(D=y(A),D.setFourCC(0,"FORM"),D.setUint32(4,A-8),D.setFourCC(8,this.type),F=0;F<this.chunks.length;)O=this.chunks[F++],D.setFourCC(G,O.type),D.setUint32(G+4,O.length),D.setUint8Array(G+8,O.data),G+=8+O.length,G%2&&G++;return D.buffer}}),C=x.subClass({init:function(A){if(this.super.init.call(this,A),A){if("IFRS"!==this.type)throw new Error("Not a Blorb file");if("RIdx"!==this.chunks[0].type)throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var F=y(this.chunks[0].data),G=4;G<this.chunks[0].data.length;){if("Exec"===F.getFourCC(G)&&0===F.getUint32(G+4))return void(this.exec=this.chunks.filter(function(D){return D.offset===F.getUint32(G+8)})[0]);G+=12}}}}),S=x.subClass({init:function(A){if(this.super.init.call(this,A),A){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var G,D,O,F=0;F<this.chunks.length;)G=this.chunks[F].type,D=this.chunks[F++].data,"CMem"===G||"UMem"===G?(this.memory=D,this.compressed="CMem"==G):"Stks"===G?this.stacks=D:"IFhd"===G&&(O=y(D.buffer),this.release=O.getUint16(0),this.serial=O.getUint8Array(2,6),this.checksum=O.getUint16(8),this.pc=16777215&O.getUint32(9))}},write:function(){this.type="IFZS";var A=y(13);return A.setUint16(0,this.release),A.setUint8Array(2,this.serial),A.setUint32(9,this.pc),A.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:A},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});U.exports={IFF:x,Blorb:C,Quetzal:S,identify:function(A){var G,D,O,F=y(A);if("FORM"===F.getFourCC(0)&&"IFRS"===F.getFourCC(8)?(G=new C(A),G.exec&&(D=G.exec.type,A=G.exec.data,"GLUL"===D&&(F=y(A),O=F.getUint32(4)),"ZCOD"===D&&(O=A[0]))):"Glul"===F.getFourCC(0)?(D="GLUL",O=F.getUint32(4)):(O=F.getUint8(0),0<O&&9>O&&(D="ZCOD")),D&&O)return{format:D,version:O,data:A}}}},{"./utils.js":4}],4:[function(h,U){"use strict";function w(){for(var G,D,A=arguments[0],F=1;F<arguments.length;)for(D in G=arguments[F++],G)A[D]=G[D];return A}function v(){}function S(A){for(var F=0,G=A.length,D=new Uint16Array(G/2);F<G;)D[F/2]=A[F++]<<8|A[F++];return D}v.subClass=function(A){function F(){this.init&&this.init.apply(this,arguments)}return F.prototype=w(Object.create(this.prototype),A),F.subClass=this.subClass,F.super=F.prototype.super=this.prototype,F},U.exports={extend:w,Class:v,MemoryView:function(A,F,G){return"number"==typeof A&&(A=new ArrayBuffer(A)),A.buffer&&(A=A.buffer),w(new DataView(A,F,G),{getUint8Array:function(D,O){return new Uint8Array(this.buffer.slice(D,D+O))},getUint16Array:function(D,O){return S(new Uint8Array(this.buffer,D,2*O))},setUint8Array:function(D,O){O instanceof ArrayBuffer&&(O=new Uint8Array(O)),new Uint8Array(this.buffer).set(O,D)},getFourCC:function(D){return _StringfromCharCode(this.getUint8(D),this.getUint8(D+1),this.getUint8(D+2),this.getUint8(D+3))},setFourCC:function(D,O){this.setUint8(D,O.charCodeAt(0)),this.setUint8(D+1,O.charCodeAt(1)),this.setUint8(D+2,O.charCodeAt(2)),this.setUint8(D+3,O.charCodeAt(3))}})},U2S16:function(A){return A<<16>>16},S2U16:function(A){return 65535&A},Uint8toUint16Array:S}},{}],5:[function(h,U){"use strict";var w=h("./common/utils.js"),v=h("./common/file.js"),y={stack_len:100000,undo_len:1000000},C=w.Class.subClass(w.extend({init:function(){this.jit={},this.init=this.start},prepare:function(S,A){if(!A.Glk)throw new Error("A reference to Glk is required");this.Glk=A.Glk,this.data=S,this.options=w.extend({},y,A)},start:function(){var A,S=this.Glk;try{if(A=v.identify(this.data),delete this.data,!A||"ZCOD"!==A.format)throw new Error("This is not a Z-Code file");if(0>[3,4,5,8].indexOf(A.version))throw new Error("Unsupported Z-Machine version: "+A.version);this.m=w.MemoryView(A.data),this.staticmem=this.m.getUint16(14),this.ram=w.MemoryView(this.m.buffer,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem);let F="",G=0;for(;30>G;)F+=(16>this.origram[G]?"0":"")+this.origram[G++].toString(16);this.signature=F;let D;const O=this.options.Dialog;if(O)if(this.options.clear_vm_autosave)O.autosave_write(F,null);else if(this.options.do_vm_autosave)try{const E=O.autosave_read(F);E&&(this.do_autorestore(E),D=1)}catch(E){this.log("Autorestore failed, deleting it"),O.autosave_write(F,null)}D||(this.restart(),this.run()),this.quit||(this.glk_event=new S.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):S.glk_select(this.glk_event)),S.update()}catch(F){throw F instanceof Error&&(F.message="ZVM start: "+F.message),S.fatal_error(F),F}},resume:function(S){var G,D,A=this.Glk,F=this.glk_event;try{G=F.get_field(0),2===G&&(this.handle_char_input(F.get_field(2)),D=1),3===G&&(this.handle_line_input(F.get_field(2),F.get_field(3)),D=1),5===G&&this.update_width(),"fileref_create_by_prompt"===G&&(D=this.handle_create_fileref(S)),this.glk_blocking_call=null,D&&this.run(),this.quit||(this.glk_event=new A.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):A.glk_select(this.glk_event)),A.update()}catch(O){throw O instanceof Error&&(O.message="ZVM: "+O.message),A.fatal_error(O),O}},get_signature:function(){return this.signature},run:function(){var S,A;for(this.stop=0;!this.stop;)S=this.pc,this.jit[S]||this.compile(),A=this.jit[S](this),isNaN(A)||this.ret(A)},compile:function(){var S=this.disassemble();this.jit[S.pc]=new Function("e",""+S),S.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+S.pc)}},h("./zvm/runtime.js"),h("./zvm/text.js"),h("./zvm/io.js"),h("./zvm/disassembler.js")));U.exports=C},{"./common/file.js":3,"./common/utils.js":4,"./zvm/disassembler.js":6,"./zvm/io.js":7,"./zvm/runtime.js":9,"./zvm/text.js":10}],6:[function(h,U){var w=h("../common/ast.js");U.exports.disassemble=function(){function v(M,z){for(var B=0;4>B;B++)z.push((192&M)>>6),M<<=2}for(var y,x,A,F,G,D,O,C=this.m,S=this.opcodes,E=new w.RoutineContext(this,this.pc);;){if(x=y=this.pc,F=C.getUint8(y++),190===F?(D=-1,F=C.getUint8(y++)+1e3):128&F?64&F?(D=-1,!(32&F)&&(F&=31)):(D=[(48&F)>>4],3>D[0]&&(F&=207)):(D=[64&F?2:1,32&F?2:1],F&=31),!S[F])throw this.log(""+E),this.stop=1,new Error("Unknown opcode #"+F+" at pc="+x);for(G=S[F].prototype,-1===D&&(D=[],v(C.getUint8(y++),D),(236===F||250===F)&&v(C.getUint8(y++),D)),O=[],A=0;A<D.length;)0===D[A]&&(O.push(new w.Operand(this,C.getUint16(y))),y+=2),1===D[A]&&O.push(new w.Operand(this,C.getUint8(y++))),2===D[A++]&&O.push(new w.Variable(this,C.getUint8(y++)));if(G.storer&&O.push(new w.Variable(this,C.getUint8(y++))),G.brancher&&(A=C.getUint8(y++),O.push([128&A,64&A?63&A:(A<<8|C.getUint8(y++))<<18>>18])),G.printer)for(O.push(y);y<this.eof&&(A=C.getUint8(y),y+=2,!(128&A)););if(this.pc=y,E.ops.push(new S[F](this,E,F,x,y,O)),A=0,G.stopper&&!A)break}return E}},{"../common/ast.js":2}],7:[function(h,U){"use strict";var w=h("../common/utils.js"),v=w.U2S16,y=function(){for(var C={4294967283:146,4294967284:152,4294967285:148,4294967286:154,4294967288:27,4294967289:8,4294967290:13,4294967291:130,4294967292:129,4294967293:132,4294967294:131},S=0;12>S;)C[4294967279-S]=133+S++;return C}(),x=[[0,2,1,7,4,7,5,7,9,10,6,3,6,3,6,3],[0,0,1,1,4,4,5,5,9,9,6,6,3,3,7,7]];U.exports={init_io:function(){var C=this.Glk;this.io=this.io||{reverse:0,bold:0,italic:0,mono:2&this.m.getUint8(17),transcript:1&this.m.getUint8(17),streams:[0,1,{},[],{}],currentwin:0,height:0,maxheight:0,seenheight:0,width:0,row:0,col:0},this.mainwin||(this.mainwin=C.glk_window_open(0,0,0,3,201),C.glk_set_window(this.mainwin),this.version3&&(this.statuswin=C.glk_window_open(this.mainwin,18,1,4,202),this.statuswin&&C.glk_set_style_stream(C.glk_window_get_stream(this.statuswin),x[1][8])))},erase_line:function(C){if(1===C){var S=this.io,A=S.row,F=S.col;this._print(Array(S.width-S.col+1).join(" ")),this.set_cursor(A,F)}},erase_window:function(C){1>C&&this.Glk.glk_window_clear(this.mainwin),(1===C||-2===C)&&this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),this.set_cursor(0,0)),-1===C&&this.split_window(0)},fileref_create_by_prompt:function(C){"undefined"==typeof C.run&&(C.run=1),this.fileref_data=C,this.glk_blocking_call="fileref_create_by_prompt",this.Glk.glk_fileref_create_by_prompt(C.usage,C.mode,C.rock||0)},fix_upper_window:function(){var C=this.Glk,S=this.io;S.seenheight===S.maxheight&&(S.maxheight=S.height),this.upperwin&&(0===S.maxheight?(C.glk_window_close(this.upperwin),this.upperwin=null):C.glk_window_set_arrangement(C.glk_window_get_parent(this.upperwin),18,S.maxheight,null)),S.seenheight=S.maxheight,S.maxheight=S.height},format:function(){this.Glk.glk_set_style(x[this.io.currentwin][!!this.io.mono|this.io.italic|this.io.bold|this.io.reverse])},get_cursor:function(C){this.ram.setUint16(C,this.io.row+1),this.ram.setUint16(C+2,this.io.col+1)},handle_char_input:function(C){var S=this.io.streams[4],A=y[C]||this.reverse_unicode_table[C]||63;this.variable(this.read_data.storer,A),1===S.mode&&(S.cache+=A),2===S.mode&&this.Glk.glk_put_char_stream_uni(S.str,A)},handle_create_fileref:function(C){var F,S=this.Glk,A=this.fileref_data;return C&&(F=A.unicode?S.glk_stream_open_file_uni(C,A.mode,A.rock||0):S.glk_stream_open_file(C,A.mode,A.rock||0),S.glk_fileref_destroy(C)),("restore"===A.func||"save"===A.func)&&this.save_restore_handler(F),"input_stream"===A.func&&(this.io.streams[0]=F),"output_stream"===A.func&&this.output_stream_handler(F),A.run},handle_line_input:function(C,S){var A=this.ram,F=this.read_data,G=this.io.streams,D=_StringfromCharCode.apply(null,F.buffer.slice(0,C))+"\n",O=this.text_to_zscii(D.slice(0,-1).toLowerCase());1===G[2].mode&&(G[2].cache+=D),2===G[2].mode&&this.Glk.glk_put_jstring_stream(G[2].str,D),1===G[4].mode&&(G[4].cache+=D),2===G[4].mode&&this.Glk.glk_put_jstring_stream(G[4].str,D),5>this.version?(O.push(0),A.setUint8Array(F.bufaddr+1,O)):(A.setUint8(F.bufaddr+1,C),A.setUint8Array(F.bufaddr+2,O),this.variable(F.storer,isNaN(S)?13:S)),F.parseaddr&&this.tokenise(F.bufaddr,F.parseaddr)},input_stream:function(C){var S=this.io;C&&!S.streams[0]&&this.fileref_create_by_prompt({func:"input_stream",mode:2,rock:212,unicode:1,usage:259}),!C&&S.streams[0]&&(this.Glk.glk_stream_close(S.streams[0]),S.streams[0]=0)},output_stream:function(C,S,A){var D,O,F=this.ram,G=this.io.streams;C=v(C),1===C&&(G[1]=1),-1===C&&(G[1]=0),2!==C||G[2].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:210,run:!A,str:2,unicode:1,usage:258}),G[2].cache="",G[2].mode=1,!A&&(this.stop=1)),-2===C&&(F.setUint8(17,254&F.getUint8(17)),2===G[2].mode&&this.Glk.glk_stream_close(G[2].str),G[2].mode=this.io.transcript=0),3===C&&G[3].unshift([S,""]),-3===C&&(D=G[3].shift(),O=this.text_to_zscii(D[1]),F.setUint16(D[0],O.length),F.setUint8Array(D[0]+2,O)),4!==C||G[4].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:211,str:4,unicode:1,usage:259}),G[4].cache="",G[4].mode=1,this.stop=1),-4===C&&(2===G[4].mode&&this.Glk.glk_stream_close(G[4].str),G[4].mode=0)},output_stream_handler:function(C){var S=this.ram,A=this.io.streams,F=this.fileref_data;2===F.str&&(S.setUint8(17,254&S.getUint8(17)|(C?1:0)),C?(A[2].mode=2,A[2].str=C,this.io.transcript=1,A[2].cache&&this.Glk.glk_put_jstring_stream(A[2].str,A[2].cache)):A[2].mode=this.io.transcript=0),4===F.str&&(C?(A[4].mode=2,A[4].str=C,A[4].cache&&this.Glk.glk_put_jstring_stream(A[4].str,A[4].cache)):A[4].mode=0)},_print:function(C){var S=this.Glk,A=this.io,F=0;if(A.streams[3].length)A.streams[3][0][1]+=C;else if(C=C.replace(/\r/g,"\n"),(1&this.m.getUint8(17))!==A.transcript&&this.output_stream(A.transcript?-2:2,0,1),(2&this.m.getUint8(17))!=(2&A.mono)&&(A.mono^=2,this.format()),A.currentwin&&this.upperwin)for(;F<C.length&&A.row<A.height;)S.glk_put_jstring(C[F++]),A.col++,A.col===A.width&&(A.col=0,A.row++);else A.currentwin||(A.streams[1]&&S.glk_put_jstring(C),1===A.streams[2].mode&&(A.streams[2].cache+=C),2===A.streams[2].mode&&S.glk_put_jstring_stream(A.streams[2].str,C))},print:function(C,S){var A,F;if(0===C&&(F=S),1===C&&(F=_StringfromCharCode(S)),2===C&&(F=this.jit[S]||this.decode(S)),3===C&&(A=this.m.getUint16(this.objects+(this.version3?9:14)*S+(this.version3?7:12)),F=this.decode(A+1,2*this.m.getUint8(A))),4===C){if(!this.unicode_table[S])return;F=this.unicode_table[S]}this._print(""+F)},print_table:function(C,S,A,F){A=A||1,F=F||0;for(var G=0;G++<A;)this._print(this.zscii_to_text(this.m.getUint8Array(C,S))+(G<A?"\r":"")),C+=S+F},process_colours:function(){},read:function(C,S,A,F,G){var E,M,D=this.m.getUint8(S);if(this.version3&&(D++,this.v3_status()),E=Array(D),E.fill(0),this.read_data={buffer:E,bufaddr:S,parseaddr:A,routine:G,storer:C,time:F},this.io.streams[0]){if(M=this.Glk.glk_get_line_stream_uni(this.io.streams[0],E),10===E[M-1]&&M--,M)return this._print(_StringfromCharCode.apply(null,E.slice(0,M))+"\n"),this.handle_line_input(M),this.stop=0;this.input_stream(0)}this.Glk.glk_request_line_event_uni(this.mainwin,E,0),this.fix_upper_window()},read_char:function(C,S,A,F){if(this.io.streams[0]){var G=this.Glk.glk_get_char_stream_uni(this.io.streams[0]);if(-1===G)this.input_stream(0);else return this.variable(C,G),this.stop=0}this.read_data={routine:F,storer:C,time:A},this.Glk.glk_request_char_event_uni(this.mainwin),this.fix_upper_window()},set_colour:function(){},set_cursor:function(C,S){var A=this.io;C>=A.height&&this.split_window(C+1),this.upperwin&&0<=C&&0<=S&&S<A.width&&(this.Glk.glk_window_move_cursor(this.upperwin,S,C),A.row=C,A.col=S)},set_font:function(C){if(1!==C&&4!==C)return 0;var S=4&this.io.mono?4:1;return C!==S&&(this.io.mono^=4,this.format()),S},set_style:function(C){var S=this.io;0===C&&(S.reverse=S.bold=S.italic=0,S.mono&=254),1&C&&(S.reverse=8),2&C&&(S.bold=4),4&C&&(S.italic=2),8&C&&(S.mono|=1),this.format()},set_true_colour:function(){},set_window:function(C){this.io.currentwin=C,C&&this.set_cursor(0,0),this.Glk.glk_set_window(this.upperwin&&C?this.upperwin:this.mainwin),this.format()},split_window:function(C){var O,S=this.Glk,A=this.io,F=A.row,G=A.col,D=A.height;if(A.height=C,this.upperwin&&C>D){for(O=S.glk_window_get_stream(this.upperwin);D<C;)S.glk_window_move_cursor(this.upperwin,0,D++),S.glk_put_jstring_stream(O,Array(A.width+1).join(" "));S.glk_window_move_cursor(this.upperwin,G,F)}C>A.maxheight&&(A.maxheight=C,this.upperwin?S.glk_window_set_arrangement(S.glk_window_get_parent(this.upperwin),18,A.maxheight,null):this.upperwin=S.glk_window_open(this.mainwin,18,A.maxheight,4,203)),C&&(A.row>=C&&this.set_cursor(0,0),this.version3&&S.glk_window_clear(this.upperwin))},update_header:function(){var C=this.ram;return this.xorshift_seed=0,this.update_width(),this.version3?C.setUint8(1,64|(143&C.getUint8(1)|(this.statuswin?32:16))):void(C.setUint8(1,28),C.setUint8(17,87&C.getUint8(17)),C.setUint8(32,255),4<this.version&&(C.setUint16(36,255),C.setUint16(38,257)),C.setUint16(50,258),this.extension_table(4,0))},update_width:function(){var F,C=this.Glk,S=C.glk_window_open(this.mainwin,18,0,4,204),A=new C.RefBox;C.glk_window_get_size(S||this.mainwin,A),S&&C.glk_window_close(S),this.io.width=F=_Mathmin(A.get_value(),255),3<this.version&&this.ram.setUint8(33,F),4<this.version&&this.ram.setUint16(34,F),this.io.col>=F&&(this.io.col=F-1)},v3_status:function(){if(this.statuswin){var M,C=this.Glk,S=C.glk_window_get_stream(this.statuswin),A=this.m,F=this.io.width,G=A.getUint16(this.globals+2),D=A.getUint16(this.globals+4),O=A.getUint16(this.objects+9*A.getUint16(this.globals)+7),E=""+this.decode(O+1,2*A.getUint8(O));M=2&A.getUint8(1)?"Time: "+(0==G%12?12:G%12)+":"+(10>D?"0":"")+D+" "+(11<G?"PM":"AM"):"Score: "+G+"  Turns: "+D,C.glk_window_move_cursor(this.statuswin,0,0),C.glk_put_jstring_stream(S,Array(F+1).join(" ")),C.glk_window_move_cursor(this.statuswin,0,0),C.glk_put_jstring_stream(S," "+E.slice(0,F-M.length-4)),C.glk_window_move_cursor(this.statuswin,F-M.length-1,0),C.glk_put_jstring_stream(S,M)}}}},{"../common/utils.js":4}],8:[function(h,U){"use strict";var w=h("../common/ast.js"),v=w.Variable,y=w.Opcode,x=w.Stopper,C=w.Pauser,S=w.PauserStorer,A=w.Brancher,F=w.BrancherStorer,G=w.Storer,D=w.Caller,O=w.CallerStorer,E=w.opcode_builder,M=function(N){return""+N},z=new v(this.e,0),B=E(A,function(){return 1}),R=E(G,function(N){return"e.S2U(~"+N+")"}),I=G.subClass({storer:0,post:function(){var N=this.operands,q=N[0],T=q instanceof v;N[0]=new v(this.e,T?q:q.v),(T||0===q.v)&&(N[0].indirect=1),this.storer=142===this.code?N.pop():N.shift(),0===N.length&&N.push(z)},func:M}),P=y.subClass({func:function(N){var q=N.v-1,T=this.code%2?1:-1;return N instanceof v||14<q?"e.incdec("+N+","+T+")":(0>q?"e.s[e.sp-1]":"e.l["+q+"]")+(1==T?"++":"--")}}),V=x.subClass({brancher:1,toString:function(){return"e.stop=1;e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}}),L=E(S,function(){return"e.restore("+(this.next-1)+")"}),Z=E(S,function(){return"e.save("+(this.next-1)+")"});U.exports=function(N){return{1:E(A,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:E(A,function(q,T){return q.U2S()+"<"+T.U2S()}),3:E(A,function(q,T){return q.U2S()+">"+T.U2S()}),4:E(A,function(q,T){return"e.U2S(e.incdec("+q+",-1))<"+T.U2S()}),5:E(A,function(q,T){return"e.U2S(e.incdec("+q+",1))>"+T.U2S()}),6:E(A,function(){return"e.jin("+this.args()+")"}),7:E(A,function(){return"e.test("+this.args()+")"}),8:E(G,function(){return this.args("|")}),9:E(G,function(){return this.args("&")}),10:E(A,function(){return"e.test_attr("+this.args()+")"}),11:E(y,function(){return"e.set_attr("+this.args()+")"}),12:E(y,function(){return"e.clear_attr("+this.args()+")"}),13:I,14:E(y,function(){return"e.insert_obj("+this.args()+")"}),15:E(G,function(q,T){return"e.m.getUint16(e.S2U("+q+"+2*"+T.U2S()+"))"}),16:E(G,function(q,T){return"e.m.getUint8(e.S2U("+q+"+"+T.U2S()+"))"}),17:E(G,function(){return"e.get_prop("+this.args()+")"}),18:E(G,function(){return"e.find_prop("+this.args()+")"}),19:E(G,function(){return"e.find_prop("+this.args(",0,")+")"}),20:E(G,function(){return"e.S2U("+this.args("+")+")"}),21:E(G,function(){return"e.S2U("+this.args("-")+")"}),22:E(G,function(){return"e.S2U("+this.args("*")+")"}),23:E(G,function(q,T){return"e.S2U(parseInt("+q.U2S()+"/"+T.U2S()+"))"}),24:E(G,function(q,T){return"e.S2U("+q.U2S()+"%"+T.U2S()+")"}),25:O,26:D,27:E(y,function(){return"e.set_colour("+this.args()+")"}),28:E(x,function(q,T){return"while(e.frames.length+1>"+T+"){e.frameptr=e.frames.pop()}return "+q}),128:E(A,function(q){return q+"===0"}),129:E(F,function(q){return"e.get_sibling("+q+")"}),130:E(F,function(q){return"e.get_child("+q+")"}),131:E(G,function(q){return"e.get_parent("+q+")"}),132:E(G,function(q){return"e.get_prop_len("+q+")"}),133:P,134:P,135:E(y,function(q){return"e.print(2,"+q+")"}),136:O,137:E(y,function(q){return"e.remove_obj("+q+")"}),138:E(y,function(q){return"e.print(3,"+q+")"}),139:E(x,function(q){return"return "+q}),140:E(x,function(q){return"e.pc="+q.U2S()+"+"+(this.next-2)}),141:E(y,function(q){return"e.print(2,"+q+"*"+this.e.addr_multipler+")"}),142:I.subClass({storer:1}),143:5>N?R:D,176:E(x,function(){return"return 1"}),177:E(x,function(){return"return 0"}),178:E(y,function(q){return"e.print(2,"+q+")"},{printer:1}),179:E(x,function(q){return"e.print(2,"+q+");e.print(1,13);return 1"},{printer:1}),180:y,181:4>N?V:Z,182:4>N?V:L,183:E(x,function(){return"e.erase_window(-1);e.restart()"}),184:E(x,function(q){return"return "+q},{post:function(){this.operands.push(z)}}),185:5>N?E(y,function(){return"s[--e.sp]"}):E(G,function(){return"e.frames.length+1"}),186:E(C,function(){return"e.quit=1;e.Glk.glk_exit()"}),187:E(y,function(){return"e.print(1,13)"}),188:4>N?E(x,function(){return"e.pc="+this.next+";e.v3_status()"}):y,189:B,191:B,224:O,225:E(y,function(q,T,Q){return"e.ram.setUint16(e.S2U("+q+"+2*"+T.U2S()+"),"+Q+")"}),226:E(y,function(q,T,Q){return"e.ram.setUint8(e.S2U("+q+"+"+T.U2S()+"),"+Q+")"}),227:E(y,function(){return"e.put_prop("+this.args()+")"}),228:5>N?E(C,function(){return"e.read(0,"+this.args()+")"}):E(S,function(){return"e.read("+this.storer.v+","+this.args()+")"}),229:E(y,function(q){return"e.print(4,"+q+")"}),230:E(y,function(q){return"e.print(0,"+q.U2S()+")"}),231:E(G,function(q){return"e.random("+q.U2S()+")"}),232:E(G,M,{post:function(){this.storer=z},storer:0}),233:I,234:E(y,function(q){return"e.split_window("+q+")"}),235:E(y,function(q){return"e.set_window("+q+")"}),236:O,237:E(y,function(q){return"e.erase_window("+q.U2S()+")"}),238:E(y,function(q){return"e.erase_line("+q+")"}),239:E(y,function(q,T){return"e.set_cursor("+q+"-1,"+T+"-1)"}),240:E(y,function(q){return"e.get_cursor("+q+")"}),241:E(y,function(q){return"e.set_style("+q+")"}),242:y,243:E(x,function(){return"e.pc="+this.next+";e.output_stream("+this.args()+")"}),244:E(C,function(){return"e.input_stream("+this.args()+")"}),245:y,246:E(S,function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"}),247:E(F,function(){return"e.scan_table("+this.args()+")"}),248:R,249:D,250:D,251:E(y,function(){return"e.tokenise("+this.args()+")"}),252:E(y,function(){return"e.encode_text("+this.args()+")"}),253:E(y,function(){return"e.copy_table("+this.args()+")"}),254:E(y,function(){return"e.print_table("+this.args()+")"}),255:E(A,function(q){return"e.stack.getUint8(e.frameptr+5)&(1<<("+q+"-1))"}),1e3:Z,1001:L,1002:E(G,function(q,T){return"e.S2U(e.log_shift("+q+","+T.U2S()+"))"}),1003:E(G,function(q,T){return"e.S2U(e.art_shift("+q.U2S()+","+T.U2S()+"))"}),1004:E(G,function(q){return"e.set_font("+q+")"}),1009:E(G,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:E(y,function(){return"if(e.restore_undo())return"},{storer:1}),1011:E(y,function(q){return"e.print(1,"+q+")"}),1012:E(G,function(){return 3}),1013:E(y,function(){return"e.set_true_colour("+this.args()+")"}),1014:y.subClass({brancher:1}),1030:E(G,function(){return"e.gestalt("+this.args()+")"})}}},{"../common/ast.js":2}],9:[function(h,U){"use strict";function w(G,D,O,E){if(F&&!E)for(;D<O;)G.setUint16(D,G.getUint16(D,1)),D+=2}const v=h("clone"),y=h("../common/file.js"),x=h("../common/utils.js"),C=x.extend,S=x.U2S16,A=x.S2U16,F=function(){var G=new Uint8Array(2),D=new Uint16Array(G.buffer);return D[0]=1,1===G[0]}();U.exports={art_shift:function(G,D){return 0<D?G<<D:G>>-D},call:function(G,D,O,E){if(0===G)return 0<=D&&this.variable(D,0),this.pc=O;this.pc=G*this.addr_multipler;var M=this.m.getUint8(this.pc++),z=this.stack,B=0,R=this.frameptr;for(z.setUint16(R+6,this.sp),this.frames.push(R),R=this.frameptr=this.s.byteOffset+2*this.sp,z.setUint32(R,O<<8),z.setUint8(R+3,(0<=D?0:16)|M),z.setUint8(R+4,0<=D?D:0),z.setUint8(R+5,(1<<E.length)-1),this.make_stacks(),this.sp=0;B<M;)this.l[B]=B<E.length?E[B]:5>this.version?this.m.getUint16(this.pc+2*B):0,B++;5>this.version&&(this.pc+=2*M)},clear_attr:function(G,D){var O=0|this.objects+(this.version3?9:14)*G+D/8;this.ram.setUint8(O,this.m.getUint8(O)&~(128>>D%8))},copy_table:function(G,D,O){O=S(O);var E=this.ram,M=0,z=0>O;if(O=Math.abs(O),0===D){for(;M<O;)E.setUint8(G+M++,0);return}if(z)for(;M<O;)E.setUint8(D+M,this.m.getUint8(G+M++));else E.setUint8Array(D,this.m.getUint8Array(G,O))},do_autorestore:function(G){const D=this.Glk;D.restore_allstate(G.glk),this.io=G.io;const O=new D.RefBox;let E;for(;E=D.glk_window_iterate(E,O);)201===O.value&&(this.mainwin=E,E.linebuf&&(G.read_data.buffer=E.linebuf)),202===O.value&&(this.statuswin=E),203===O.value&&(this.upperwin=E);for(E=null;E=D.glk_stream_iterate(E,O);)210===O.value&&(this.io.streams[2].str=E),211===O.value&&(this.io.streams[4].str=E);this.restart(),this.restore_file(new Uint8Array(G.ram),1),this.read_data=G.read_data,this.xorshift_seed=G.xorshift_seed},do_autosave:function(G){if(!this.options.Dialog)throw new Error("A reference to Dialog is required");let D=null;0<=(G||0)&&(D={glk:this.Glk.save_allstate(),io:v(this.io),ram:this.save_file(this.pc,1),read_data:v(this.read_data),xorshift_seed:this.xorshift_seed},delete D.io.streams[2].str,delete D.io.streams[2].str,delete D.read_data.buffer),this.options.Dialog.autosave_write(this.signature,D)},encode_text:function(G,D,O,E){this.ram.setUint8Array(E,this.encode(this.m.getUint8Array(G+O,D)))},extension_table:function(G,D){var O=this.extension;return!O||G>this.extension_count?0:(O+=2*G,void 0===D?this.m.getUint16(O):void this.ram.setUint16(O,D))},find_prop:function(G,D,O){var z,B,E=this.m,M=this.version3,R=0,I=E.getUint16(this.objects+(M?9:14)*G+(M?7:12));for(I+=2*E.getUint8(I)+1;;){if(z=E.getUint8(I),B=z&(M?31:63),R===O)return B;if(B===D)return I+(!M&&128&z?2:1);if(B<D)return 0;R=B,M?I+=(z>>5)+2:128&z?(B=63&E.getUint8(I+1),I+=B?B+2:66):I+=64&z?3:2}},gestalt:function(G){return 1===G?258:8192===G?1:8193===G||8194===G?2:0},get_child:function(G){return this.version3?this.m.getUint8(this.objects+9*G+6):this.m.getUint16(this.objects+14*G+10)},get_sibling:function(G){return this.version3?this.m.getUint8(this.objects+9*G+5):this.m.getUint16(this.objects+14*G+8)},get_parent:function(G){return this.version3?this.m.getUint8(this.objects+9*G+4):this.m.getUint16(this.objects+14*G+6)},get_prop:function(G,D){var M,O=this.m,E=this.find_prop(G,D);return E?(M=O.getUint8(E-1),O[(this.version3?M>>5:64&M)?"getUint16":"getUint8"](E)):O.getUint16(this.properties+2*(D-1))},get_prop_len:function(G){if(0===G)return 0;var D=this.m.getUint8(G-1);return this.version3?(D>>5)+1:128&D?(D&=63,0===D?64:D):64&D?2:1},incdec:function(G,D){if(0===G)return this.s[this.sp-1]+=D,this.s[this.sp-1];if(15>--G)return this.l[G]+=D,this.l[G];var O=this.globals+2*(G-15);return this.ram.setUint16(O,this.m.getUint16(O)+D),this.ram.getUint16(O)},indirect:function(G,D){return 0===G?1<arguments.length?this.s[this.sp-1]=D:this.s[this.sp-1]:this.variable(G,D)},insert_obj:function(G,D){this.remove_obj(G),this.set_family(G,D,D,G,G,this.get_child(D))},jeq:function(){for(var G=1;G<arguments.length;)if(arguments[G++]===arguments[0])return 1},jin:function(G,D){return this.get_parent(G)===D},log:function(G){this.options.GlkOte&&this.options.GlkOte.log(G)},log_shift:function(G,D){return 0<D?G<<D:G>>>-D},make_stacks:function(){var G=15&this.stack.getUint8(this.frameptr+3);this.l=new Uint16Array(this.stack.buffer,this.frameptr+8,G),this.s=new Uint16Array(this.stack.buffer,this.frameptr+8+2*G)},put_prop:function(G,D,O){var M,E=this.find_prop(G,D);E&&(M=this.m.getUint8(E-1),this.ram[(this.version3?M>>5:64&M)?"setUint16":"setUint8"](E,O))},random:function(G){var D=this.xorshift_seed;return 1>G?(this.xorshift_seed=G,0):0===D?0|1+Math.random()*G:(D^=D<<13,D^=D>>17,this.xorshift_seed=D^=D<<5,1+(32767&D)%G)},remove_obj:function(G){var O,E,M,D=this.get_parent(G);if(0!==D)if(O=this.get_child(D),E=this.get_sibling(G),O===G)this.set_family(G,0,D,E);else{for(;M=this.get_sibling(O),M!==G;)O=M;this.set_family(G,0,0,0,O,E)}},restart:function(){var G=this.ram,D=G.getUint8(0),O=3===D,E=O?2:8===D?8:4,M=G.getUint8(17),z=G.getUint16(10),B=4<D?G.getUint16(54):0,R=x.MemoryView(this.options.stack_len);G.setUint8Array(0,this.origram),G.setUint8(17,M),C(this,{stack:R,frameptr:0,frames:[],s:new Uint16Array(R.buffer,8),sp:0,l:[],undo:[],undo_len:0,glk_blocking_call:null,version:D,version3:O,pc:G.getUint16(6),properties:z,objects:z+(O?53:112),globals:G.getUint16(12),eof:(G.getUint16(26)||65536)*E,extension:B,extension_count:B?G.getUint16(B):0,addr_multipler:E,opcodes:h("./opcodes.js")(D)}),this.init_text(),this.init_io(),this.update_header()},restore:function(G){this.pc=G,this.fileref_create_by_prompt({func:"restore",mode:2,usage:1})},restore_file:function(G,D){var R,O=this.ram,E=new y.Quetzal(G),M=E.memory,z=this.stack,B=O.getUint8(17),I=0,P=0;if(O.getUint16(2)!==E.release||O.getUint16(28)!==E.checksum)return 0;for(;6>I;)if(O.getUint8(18+I)!==E.serial[I++])return 0;if(I=0,O.setUint8Array(0,this.origram),E.compressed)for(;I<M.length;)R=M[I++],0===R?P+=1+M[I++]:O.setUint8(P,R^this.origram[P++]);else O.setUint8Array(0,M);for(O.setUint8(17,B),z.setUint8Array(0,E.stacks),this.frames=[],I=0;I<E.stacks.byteLength;)this.frameptr=I,this.frames.push(I),w(z,P=I+8,P+=2*(15&z.getUint8(I+3)),D),w(z,P,P+=2*z.getUint16(I+6),D),I=P;return this.frames.pop(),this.sp=z.getUint16(this.frameptr+6),this.make_stacks(),this.pc=E.pc,this.update_header(),this.version3&&this.split_window(0),2},restore_undo:function(){if(0===this.undo.length)return 0;var G=this.undo.pop();return this.frameptr=G.frameptr,this.pc=G.pc,this.undo_len-=G.ram.byteLength+G.stack.byteLength,G.ram[17]=this.m.getUint8(17),this.ram.setUint8Array(0,G.ram),this.frames=G.frames,this.sp=G.sp,this.stack.setUint8Array(0,G.stack),this.make_stacks(),this.variable(G.var,2),1},ret:function(G){var D=this.stack,O=this.frameptr,E=16&D.getUint8(O+3)?-1:D.getUint8(O+4);this.pc=D.getUint32(O)>>8,O=this.frameptr=this.frames.pop(),this.make_stacks(),this.sp=D.getUint16(O+6),0<=E&&this.variable(E,G||0)},save:function(G){this.pc=G,this.fileref_create_by_prompt({func:"save",mode:1,usage:1})},save_file:function(G,D){var B,R,P,O=this.m,E=new y.Quetzal,M=x.MemoryView(this.stack.buffer.slice()),z=0,I=this.frameptr;if(E.release=O.getUint16(2),E.serial=O.getUint8Array(18,6),E.checksum=O.getUint16(28),E.pc=G,D)E.memory=this.m.getUint8Array(0,this.staticmem);else{const V=[];for(E.compressed=1,B=0;B<this.staticmem;B++)P=O.getUint8(B)^this.origram[B],0===P?256==++z&&(V.push(0,255),z=0):(z&&(V.push(0,z-1),z=0),V.push(P));E.memory=V}if(M.setUint16(I+6,this.sp),F&&!D){const V=this.frames.slice();for(V.push(I),B=0;B<V.length;B++)I=V[B],w(M,R=I+8,R+=2*(15&M.getUint8(I+3))),w(M,R,R+=2*M.getUint16(I+6))}return E.stacks=M.getUint8Array(0,this.frameptr+8+2*(15&M.getUint8(I+3))+2*this.sp),E.write()},save_restore_handler:function(G){var z,B,R,D=this.m,O=this.Glk,E=0,M=[];G&&("save"===this.fileref_data.func?(O.glk_put_buffer_stream(G,new Uint8Array(this.save_file(this.pc))),E=1):(M=new Uint8Array(131072),O.glk_get_buffer_stream(G,M),E=this.restore_file(M.buffer)),O.glk_stream_close(G)),this.version3?(z=D.getUint8(this.pc++),B=128&z,R=64&z?63&z:(z<<8|D.getUint8(this.pc++))<<18>>18,!E==!B&&(0===R||1===R?this.ret(R):this.pc+=R-2)):this.variable(D.getUint8(this.pc++),E)},save_undo:function(G,D){return this.undo_len>this.options.undo_len&&this.undo.shift(),this.undo_len+=this.staticmem+this.s.byteOffset+2*this.sp,this.undo.push({frameptr:this.frameptr,frames:this.frames.slice(),pc:G,ram:this.m.getUint8Array(0,this.staticmem),sp:this.sp,stack:this.stack.getUint8Array(0,this.s.byteOffset+2*this.sp),var:D}),1},scan_table:function(G,D,O,E){E=E||130;var M=128&E?"getUint16":"getUint8";for(E&=127,O=D+O*E;D<O;){if(this.m[M](D)===G)return D;D+=E}return 0},set_attr:function(G,D){var O=0|this.objects+(this.version3?9:14)*G+D/8;this.ram.setUint8(O,this.m.getUint8(O)|128>>D%8)},set_family:function(G,D,O,E,M,z){var B=this.ram,R=this.objects;this.version3?(B.setUint8(R+9*G+4,D),O&&B.setUint8(R+9*O+6,E),M&&B.setUint8(R+9*M+5,z)):(B.setUint16(R+14*G+6,D),O&&B.setUint16(R+14*O+10,E),M&&B.setUint16(R+14*M+8,z))},test:function(G,D){return(G&D)===D},test_attr:function(G,D){return 128&this.m.getUint8(0|this.objects+(this.version3?9:14)*G+D/8)<<D%8},variable:function(G,D){var E,O=D!==void 0;if(0===G){if(O)this.s[this.sp++]=D;else return this.s[--this.sp];}else if(15>--G){if(O)this.l[G]=D;else return this.l[G];}else if(E=this.globals+2*(G-15),O)this.ram.setUint16(E,D);else return this.m.getUint16(E);return D},U2S:S,S2U:A}},{"../common/file.js":3,"../common/utils.js":4,"./opcodes.js":8,clone:1}],10:[function(h,U){U.exports={init_text:function(){var y=this,x=this.m,C=4<this.version&&x.getUint16(52),S=this.extension_table(3),A=S&&x.getUint8(S++);this.abbr_addr=x.getUint16(24),function(F){for(var G=[[],[],[]],D=0;78>D;)G[0|D/26][D%26]=F[D++];G[2][1]=13,y.alphabets=G}(C?x.getUint8Array(C,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),function(F){for(var G={13:"\r"},D={13:13},O=0;O<F.length;)G[155+O]=_StringfromCharCode(F[O]),D[F[O]]=155+O++;for(O=32;127>O;)G[O]=_StringfromCharCode(O),D[O]=O++;y.unicode_table=G,y.reverse_unicode_table=D}(S?x.getUint16Array(S,A):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=x.getUint16(8),this.parse_dict(this.dict)},decode:function(w,v){var C,F,E,M,y=this.m,x=w,S=[],A=0,G=0,D=[],O=[],z=0;if(this.jit[w])return this.jit[w];for(v=v?v+w:this.eof;w<v&&(C=y.getUint16(w),w+=2,S.push(31&C>>10,31&C>>5,31&C),!(32768&C)););for(;A<S.length;){if(F=S[A++],0===F)D.push(32);else if(4>F)E=1,D.push(-1),O.push("\uE000+this.abbr("+(32*(F-1)+S[A++])+")+\uE000");else if(6>F)G=F;else if(2!=G||6!==F)32>F&&D.push(this.alphabets[G][F-6]);else if(A+1<S.length)if(M=S[A++]<<5|S[A++],768>M)D.push(M);else{for(M-=767,z+=M,C=A,A=A%3+3;M--;)D.push(-1),O.push(_StringfromCharCode(S[A]<<10|S[A+1]<<5|S[A+2])),S[A++]=S[A++]=S[A++]=32;A=C}G=4>G?0:G-3,0==A%3&&(A+=z,z=0)}return D=this.zscii_to_text(D,O),E&&(D={toString:Function("return\""+D.replace(/\\/g,"\\\\").replace(/"/g,"\\\"").replace(/\r/g,"\\r").replace(/\uE000/g,"\"")+"\"").bind(this)}),x>=this.staticmem&&(this.jit[x]=D),D},encode:function(w){for(var S,A,v=this.alphabets,y=[],x=this.version3?6:9,C=0,F=[];y.length<x;)S=w[C++],32===S?y.push(0):0<=(A=v[0].indexOf(S))?y.push(A+6):0<=(A=v[1].indexOf(S))?y.push(4,A+6):0<=(A=v[2].indexOf(S))?y.push(5,A+6):(A=this.reverse_unicode_table[S])?y.push(5,6,A>>5,31&A):void 0===S&&y.push(5);for(y.length=x,C=0;C<x;)F.push(y[C++]<<2|y[C]>>3,(7&y[C++])<<5|y[C++]);return F[F.length-2]|=128,F},zscii_to_text:function(w,v){for(var C,y=0,x=w.length,S=0,A="";y<x;)C=w[y++],-1===C&&(A+=v[S++]),(C=this.unicode_table[C])&&(A+=C);return A},text_to_zscii:function(w,v){for(var S,y=[],x=0,C=w.length;x<C;)S=w.charCodeAt(x++),v||(S=this.reverse_unicode_table[S]||63),y.push(S);return y},parse_dict:function(w){var C,S,v=this.m,y=w,x={},A=v.getUint8(w++);for(x.separators=Array.prototype.slice.call(v.getUint8Array(w,A)),w+=A,C=v.getUint8(w++),S=w+2+C*v.getUint16(w),w+=2;w<S;)x[Array.prototype.toString.call(v.getUint8Array(w,this.version3?4:6))]=w,w+=C;return this.dictionaries[y]=x,x},abbr:function(w){return this.decode(2*this.m.getUint16(this.abbr_addr+2*w))},tokenise:function(w,v,y,x){y=y||this.dict,y=this.dictionaries[y]||this.parse_dict(y);var G,O,M,z,C=this.m,S=this.ram,A=1e3,F=1,D=y.separators,E=[],B=0;for(4<this.version&&(A=C.getUint8(w+F++)+2);F<A&&(G=C.getUint8(w+F),0!==G);)32===G||0<=D.indexOf(G)?(32!==G&&E.push([[G],F]),O=null):(O||(E.push([[],F]),O=E[E.length-1][0]),O.push(G)),F++;for(M=_Mathmin(E.length,C.getUint8(v));B<M;)z=y[""+this.encode(E[B][0])],(!x||z)&&(S.setUint16(v+2+4*B,z||0),S.setUint8(v+4+4*B,E[B][0].length),S.setUint8(v+5+4*B,E[B][1])),B++;S.setUint8(v+1,B)}}},{}]},{},[5])(5)});

